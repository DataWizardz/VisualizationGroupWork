<!DOCTYPE html>
<html>

<head>
	<meta charset='UTF-8' />
	<meta name='viewport' content="width = device-width, initial-scale = 1/">
	<title>
		My Map
	</title>
	<!--Leaflet-->
	<link rel="stylesheet" href="lib/leaflet/leaflet.css" />
	<script src="lib/leaflet/leaflet.js"></script>
	<script src="data/states_edited.geojson"></script>
	<script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
	<style type="text/css">
		body {
			padding: 0;
			margin: 0;
		}

		html,
		body,
		#map {
			height: 100%;
			width: 100%;
		}
	</style>
</head>

<body>
	<div id='map'></div>
	<script>
		let getStateColor = (vote_perc_dem, vote_perc_rep) => {
			if (vote_perc_dem > vote_perc_rep) {
				return 'blue';
			} else if (vote_perc_dem < vote_perc_rep) {
				return 'red';
			}
		}

		let statesStyle = (feature) => {
			return {

				fillColor: getStateColor(feature.properties.dem_perc, feature.properties.rep_perc),
				weight: 2,
				opacity: 1,
				color: 'white',
				dashArray: 3,
				fillOpacity: 0.7

			}
		}
		let map = L.map('map').setView([-108.619726, 45.000284], 13);
		let countriesLayer = L.geoJson(states, {
			style: statesStyle,
			/*
			Adds an icon containing state name on each polygon center

			Turf centroid solution (Doesnt work ????????)
			turf.center(turf.multiPolygon(feature.geometry.coordinates)).geometry.coordinates
			*/
			onEachFeature: (feature, layer) => {
				let label = L.marker(layer.getBounds().getCenter(), {
					icon: L.divIcon({
						className: 'label',
						html: feature.properties.ABBR,
						iconSize: [0, 0]
					})
				}).addTo(map)
				let full_label = L.marker(layer.getBounds().getCenter(), {
					icon: L.divIcon({
						className: 'name',
						html: feature.properties.NAME,
						iconSize: [0, 0]
					})
				}).addTo(map)
			}
		}).addTo(map);
		map.fitBounds(countriesLayer.getBounds());
		let icons = []
		let name_icons = []
		map.eachLayer(layer => { if (layer.options.icon) { layer.options.icon.options.className === "label" ? icons.push(layer) : layer } })
		map.eachLayer(layer => { if (layer.options.icon) { layer.options.icon.options.className === "name" ? name_icons.push(layer) : layer } })

		console.log(icons)
		show_label_zoom = 4
		show_name_zoom = 6
		let labels_visible = false
		let names_visible = false
		let show_hide_labels = () => {
			let cur_zoom = map.getZoom();

			if (cur_zoom < show_label_zoom) {
				labels_visible = false
				names_visible = false
				map.eachLayer((layer) => {
					if (layer.options.icon) {
						layer.remove()
					}
				});
			}
			else if (cur_zoom >= show_label_zoom && cur_zoom < show_name_zoom) {

				labels_visible = true;
				names_visible = false
				icons.map(icon => icon.addTo(map))
				map.eachLayer((layer) => {
					if (layer.options.icon) {
						if (layer.options.icon.options.className === "name") {
							layer.remove()
						}
					}
				})
			}
			else if (cur_zoom >= show_name_zoom) {
				names_visible = true
				labels_visible = false
				name_icons.map(icon => icon.addTo(map))
				map.eachLayer((layer) => {
					if (layer.options.icon) {
						if (layer.options.icon.options.className === "label") {
							layer.remove()
						}
					}
				})

			}
		}
		map.on('zoomend', show_hide_labels);
		show_hide_labels();

	</script>
</body>

</html>